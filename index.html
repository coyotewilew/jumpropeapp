<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jump Rope HIIT Timer</title>
<meta name="theme-color" content="#0b0b0c" />
<style>
  :root{
    --bg:#0b0b0c; --panel:#121316; --accent:#4ade80; --accent2:#60a5fa; --warn:#f59e0b; --text:#f8fafc; --muted:#cbd5e1;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);}  
  header{padding:16px; text-align:center; font-weight:800; letter-spacing:.5px;}
  .app{max-width:900px; margin:0 auto; padding:16px;}
  .card{background:var(--panel); border:1px solid #1f2937; border-radius:20px; padding:20px; box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .grid{display:grid; grid-template-columns:1fr; gap:16px}
  @media(min-width:720px){.grid{grid-template-columns:1.2fr .8fr}}

  .notice{display:none; background:#7f1d1d; border:1px solid #b91c1c; color:#fee2e2; padding:10px; border-radius:12px; margin:8px 0; font-size:14px}
  .notice.show{display:block}

  .big{font-size:clamp(42px, 6vw, 86px); font-weight:900; text-align:center; line-height:1;}
  .label{font-size:clamp(14px, 2vw, 18px); color:var(--muted); text-align:center; letter-spacing:.2px}
  .exercise{font-size:clamp(22px, 3.2vw, 40px); text-align:center; font-weight:800; margin-top:6px}
  .phase{display:inline-block; padding:6px 12px; border-radius:999px; font-weight:700; letter-spacing:.25px;}
  .phase.work{background:rgba(74,222,128,.15); color:var(--accent); border:1px solid rgba(74,222,128,.4)}
  .phase.rest{background:rgba(96,165,250,.15); color:var(--accent2); border:1px solid rgba(96,165,250,.4)}
  .phase.setrest{background:rgba(245,158,11,.15); color:var(--warn); border:1px solid rgba(245,158,11,.4)}

  .controls{display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:10px}
  button{appearance:none; border:none; cursor:pointer; background:#1e293b; color:#fff; padding:14px 18px; border-radius:14px; font-weight:800; letter-spacing:.3px; font-size:16px}
  button.primary{background:var(--accent); color:#0b1510}
  button.warn{background:#334155}
  button:disabled{opacity:.5; cursor:not-allowed}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#111827; border:1px solid #1f2937;}

  .row{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap}
  .progress{height:14px; background:#0f172a; border:1px solid #263244; border-radius:999px; overflow:hidden}
  .progress>div{height:100%; width:0%}
  .progress.work>div{background:linear-gradient(90deg, rgba(74,222,128,.85), rgba(34,197,94,.9))}
  .progress.rest>div{background:linear-gradient(90deg, rgba(96,165,250,.85), rgba(59,130,246,.9))}
  .progress.setrest>div{background:linear-gradient(90deg, rgba(245,158,11,.85), rgba(234,88,12,.9))}

  .list{max-height:420px; overflow:auto; border:1px solid #1f2937; border-radius:14px}
  .item{display:flex; gap:10px; align-items:center; padding:10px 12px; border-bottom:1px dashed #1f2937}
  .item:last-child{border-bottom:none}
  .badge{min-width:26px; height:26px; border-radius:50%; display:grid; place-items:center; font-size:12px; font-weight:800; background:#0f172a; border:1px solid #1f2937;}
  .item.active{background:rgba(59,130,246,.08)}

  details.settings{background:#0d1117; border:1px solid #1f2937; border-radius:16px; padding:14px}
  details.settings summary{cursor:pointer; font-weight:800}
  .settings-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:12px}
  .settings-grid label{display:grid; gap:6px; font-size:14px; color:var(--muted)}
  input[type="number"], select{width:100%; padding:12px; border-radius:12px; border:1px solid #1f2937; background:#0b1220; color:#fff}

  footer{opacity:.7; text-align:center; padding:16px; font-size:13px}

  /* Full workout progress bar */
  .full-progress {height:14px; background:#0f172a; border:1px solid #263244; border-radius:999px; overflow:hidden; margin-top:8px}
  .full-progress>div{height:100%; width:0%; background:linear-gradient(90deg, rgba(250,204,21,.85), rgba(245,158,11,.9))}

  /* Test output */
  #testOutput{white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; background:#0b1220; color:#e5e7eb; border:1px solid #1f2937; border-radius:12px; padding:10px; max-height:220px; overflow:auto}
</style>
</head>
<body>
  <header>JUMP ROPE HIIT ‚Ä¢ <span style="opacity:.7">Bold Timer</span></header>
  <div class="app grid">
    <section class="card">
      <div id="notice" class="notice">An error occurred while starting the preview. See console for details.</div>

      <div class="row" style="justify-content:space-between">
        <div class="pill">Set <strong id="setNow">1</strong> / <span id="setTotal">5</span></div>
        <div class="pill">Step <strong id="stepNow">1</strong> / <span id="stepTotal">‚Äî</span></div>
        <div class="pill">Next: <span id="nextLabel">‚Äî</span></div>
      </div>

      <div style="text-align:center; margin:16px 0 6px">
        <span id="phaseTag" class="phase work">WORK</span>
      </div>

      <div class="exercise" id="exerciseName">Basic Bounce (Jump Rope)</div>
      <div class="big" id="time">00:45</div>

      <div class="progress work" aria-label="time progress" style="margin:10px 0 4px">
        <div id="bar"></div>
      </div>
      <div class="label" id="phaseHint">Go fast but relaxed. Land light.</div>

      <!-- Overall workout progress -->
      <div class="label" style="margin-top:8px">Workout progress</div>
      <div class="full-progress" aria-label="overall progress">
        <div id="totalBar"></div>
      </div>
      <div class="row" style="gap:8px; margin-bottom:6px">
        <div class="pill">Elapsed: <strong id="totalElapsed">00:00</strong></div>
        <div class="pill">Remaining: <strong id="totalRemaining">00:00</strong></div>
        <div class="pill">Total: <strong id="totalTotal">00:00</strong></div>
      </div>

      <div class="controls">
        <button id="back">‚óÄÔ∏é Back</button>
        <button id="start" class="primary">‚ñ∂ Start</button>
        <button id="pause" style="display:none" class="warn">‚è∏ Pause</button>
        <button id="reset">‚ü≤ Reset</button>
        <button id="skip">Next ‚ñ∂Ô∏é</button>
        <button id="fs">‚§¢ Fullscreen</button>
        <button id="runTests">üß™ Run Tests</button>
      </div>

      <details class="settings" style="margin-top:14px">
        <summary>Settings (durations & rounds)</summary>
        <div class="settings-grid">
          <label>Work (sec)
            <input id="workSec" type="number" min="10" max="180" step="5" value="45" />
          </label>
          <label>Rest between moves (sec)
            <input id="restSec" type="number" min="5" max="120" step="5" value="15" />
          </label>
          <label>Set rest (sec)
            <input id="setRestSec" type="number" min="10" max="300" step="5" value="60" />
          </label>
          <label>Rounds (sets)
            <input id="rounds" type="number" min="1" max="10" step="1" value="5" />
          </label>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="apply" class="primary">Apply</button>
        </div>
      </details>

      <details class="settings" style="margin-top:14px">
        <summary>Test Results</summary>
        <div id="testOutput">(No tests run yet)</div>
      </details>
    </section>

    <aside class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <div style="font-weight:800">Circuit Preview</div>
        <div class="pill">Total Steps: <span id="previewCount">‚Äî</span></div>
      </div>
      <div id="list" class="list"></div>
    </aside>
  </div>

  <footer>
    Built for Kalana ‚Ä¢ Single-file app ‚Äì just drop <code>index.html</code> in your repo and publish via GitHub Pages.
  </footer>

  <script>
  (function(){
    // ---- Global error & sandbox quirk handler (e.g., MetaMask noise) ----
    function showNotice(msg){ var n=document.getElementById('notice'); if(n){ n.textContent=msg; n.classList.add('show'); } }
    window.addEventListener('error', (e)=>{
      const msg = (e && e.message) ? e.message : '';
      if(/metamask|ethereum/i.test(msg)) { console.warn('Ignored sandbox extension error:', msg); return; }
      showNotice('Error: '+msg);
    });
    window.addEventListener('unhandledrejection', (e)=>{
      const msg = (e && e.reason && e.reason.message) ? e.reason.message : (e && e.reason ? String(e.reason) : '');
      if(/metamask|ethereum/i.test(msg)) { console.warn('Ignored sandbox extension rejection:', msg); return; }
      showNotice('Unhandled promise: '+msg);
    });

    try{
      // ===== Config =====
      const DEFAULTS = { work:45, rest:15, setRest:60, rounds:5 };
      const EXERCISES = [
        'Basic Bounce (Jump Rope)',
        'Butt Kicks (Jump Rope)',
        'Push-ups',
        'Basic Bounce (Jump Rope)',
        'High Knees (Jump Rope)',
        'Basic Bounce (Jump Rope)',
        'Jump Squats',
        'Basic Bounce (Jump Rope)',
        'Normal Squats',
      ];

      const HINTS = {
        work:{
          'Basic Bounce (Jump Rope)':'Relax shoulders, elbows in, soft feet.',
          'Butt Kicks (Jump Rope)':'Kick heels to glutes, quick wrists.',
          'Push-ups':'Tight core, chest to floor, full lockout.',
          'High Knees (Jump Rope)':'Drive knees up, stay tall, fast rope.',
          'Jump Squats':'Hips back, soft landing, stay springy.',
          'Normal Squats':'Knees track toes, chest proud.'
        },
        rest:{'*':'Breathe through the nose, shake it out.'},
        setrest:{'*':'Walk around, sip water. Nice work!'}
      };

      // ===== State =====
      let plan = [];
      let settings;
      let idx = 0; // current step index in plan
      let timeLeft = 0; // seconds remaining in current step
      let running = false;
      let timer = null;
      let totalDur = 0; // total workout seconds

      // Keep-awake state (automatic while running)
      let wakeLock = null;

      const els = {
        setNow: document.getElementById('setNow'),
        setTotal: document.getElementById('setTotal'),
        stepNow: document.getElementById('stepNow'),
        stepTotal: document.getElementById('stepTotal'),
        nextLabel: document.getElementById('nextLabel'),
        phaseTag: document.getElementById('phaseTag'),
        exerciseName: document.getElementById('exerciseName'),
        time: document.getElementById('time'),
        bar: document.getElementById('bar'),
        phaseHint: document.getElementById('phaseHint'),
        list: document.getElementById('list'),
        previewCount: document.getElementById('previewCount'),
        start: document.getElementById('start'),
        pause: document.getElementById('pause'),
        reset: document.getElementById('reset'),
        back: document.getElementById('back'),
        skip: document.getElementById('skip'),
        fs: document.getElementById('fs'),
        workSec: document.getElementById('workSec'),
        restSec: document.getElementById('restSec'),
        setRestSec: document.getElementById('setRestSec'),
        rounds: document.getElementById('rounds'),
        apply: document.getElementById('apply'),
        totalBar: document.getElementById('totalBar'),
        totalElapsed: document.getElementById('totalElapsed'),
        totalRemaining: document.getElementById('totalRemaining'),
        totalTotal: document.getElementById('totalTotal'),
        testOutput: document.getElementById('testOutput'),
        runTests: document.getElementById('runTests')
      };

      function playBeep(freq, dur){
        try{
          const ctx = new (window.AudioContext||window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type='sine'; o.frequency.value=freq||880; o.connect(g); g.connect(ctx.destination);
          o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + (dur||140)/1000);
          setTimeout(()=>{o.stop(); ctx.close();}, (dur||140)+50);
        }catch(e){/* ignore for autoplay restrictions */}
      }

      function loadSettings(){
        const raw = localStorage.getItem('jr-settings');
        if(!raw) return {...DEFAULTS};
        try{ return {...DEFAULTS, ...JSON.parse(raw)} }catch{ return {...DEFAULTS} }
      }
      function saveSettings(cfg){ localStorage.setItem('jr-settings', JSON.stringify(cfg)); }

      function buildPlan(cfg){
        const steps = [];
        totalDur = 0;
        for(let r=1;r<=cfg.rounds;r++){
          for(let i=0;i<EXERCISES.length;i++){
            const name = EXERCISES[i];
            steps.push({type:'work', label:name, dur:cfg.work, set:r});
            totalDur += cfg.work;
            const isLastInSet = i===EXERCISES.length-1;
            if(!isLastInSet){
              steps.push({type:'rest', label:'Rest', dur:cfg.rest, set:r});
              totalDur += cfg.rest;
            }else if(r<cfg.rounds){
              steps.push({type:'setrest', label:'Set Rest', dur:cfg.setRest, set:r});
              totalDur += cfg.setRest;
            }
          }
        }
        return steps;
      }

      function fmt(sec){
        const s = Math.max(0, Math.ceil(sec));
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const ss = (s%60).toString().padStart(2,'0');
        return `${m}:${ss}`;
      }

      function hintFor(step){
        if(step.type==='work'){
          return (HINTS.work[step.label]||'Own your pace. Form first.');
        }
        if(step.type==='rest') return HINTS.rest['*'];
        return HINTS.setrest['*'];
      }

      function renderList(){
        els.list.innerHTML='';
        for(let i=0;i<plan.length;i++){
          const s = plan[i];
          const div=document.createElement('div');
          div.className='item'+(i===idx?' active':'');
          const badge=document.createElement('div'); badge.className='badge'; badge.textContent=(i+1);
          const tag=document.createElement('span'); tag.className='phase '+s.type; tag.textContent=s.type==='work'?'WORK':(s.type==='rest'?'REST':'SET REST');
          const name=document.createElement('div'); name.style.fontWeight='700'; name.textContent=s.label;
          const dur=document.createElement('div'); dur.style.marginLeft='auto'; dur.style.opacity='.7'; dur.textContent=`${s.dur}s`;
          div.append(badge, tag, name, dur); els.list.append(div);
        }
        els.previewCount.textContent=plan.length;
      }

      function applyPhaseStyles(type){
        els.phaseTag.className='phase '+type;
        const prog = document.querySelector('.progress');
        prog.className='progress '+type;
      }

      function updateUI(){
        const s = plan[idx];
        if(!s) return;
        els.exerciseName.textContent = s.label;
        els.phaseTag.textContent = s.type==='work'? 'WORK' : s.type==='rest'? 'REST' : 'SET REST';
        els.time.textContent = fmt(timeLeft);
        els.phaseHint.textContent = hintFor(s);
        applyPhaseStyles(s.type);

        const done = Math.max(0, 1 - (timeLeft / s.dur));
        els.bar.style.width = (done*100).toFixed(1)+'%';

        els.stepNow.textContent = idx+1;
        els.stepTotal.textContent = plan.length;
        els.setNow.textContent = s.set;
        els.setTotal.textContent = settings.rounds;

        const next = plan[idx+1];
        els.nextLabel.textContent = next ? (next.type==='work'? next.label : (next.type==='rest'?'Rest':'Set Rest')) : 'Done';

        const items = els.list.querySelectorAll('.item');
        for(let i=0;i<items.length;i++) items[i].classList.toggle('active', i===idx);

        const elapsedBefore = plan.slice(0, idx).reduce((a,b)=>a+b.dur, 0);
        const currStep = plan[idx] ? plan[idx].dur : 0;
        const elapsed = Math.min(totalDur, Math.max(0, elapsedBefore + (currStep - timeLeft)));
        const remaining = Math.max(0, totalDur - elapsed);
        const pct = totalDur ? ((elapsed/totalDur)*100).toFixed(1) : 0;
        els.totalBar.style.width = pct+'%';
        els.totalElapsed.textContent = fmt(elapsed);
        els.totalRemaining.textContent = fmt(remaining);
        els.totalTotal.textContent = fmt(totalDur);
      }

      function stepNext(){
        if(idx < plan.length-1){
          idx++;
          timeLeft = plan[idx].dur;
          updateUI();
        } else {
          running=false;
          clearInterval(timer);
          playBeep(660,200); playBeep(440,220);
          toggleButtons();
          releaseWakeLock();
          console.log('Workout complete!');
        }
      }

      function tick(){
        if(!running) return;
        timeLeft -= 0.2; // 200ms resolution (smooth bar)
        if([3,2,1].includes(Math.ceil(timeLeft))){ playBeep(900-100*Math.ceil(timeLeft),100); }
        if(timeLeft <= 0){ playBeep(520,200); stepNext(); }
        updateUI();
      }

      function toggleButtons(){
        els.start.style.display = running? 'none':'inline-block';
        els.pause.style.display = running? 'inline-block':'none';
      }

      function start(){
        if(running) return;
        running=true; toggleButtons();
        requestWakeLock();
        timer = setInterval(tick, 200);
      }
      function pause(){
        running=false; toggleButtons(); clearInterval(timer);
        releaseWakeLock();
      }
      function reset(){ pause(); idx=0; timeLeft=plan[0].dur; updateUI(); }
      function skip(){ timeLeft=0.01; }
      function back(){ if(idx>0){ idx--; timeLeft=plan[idx].dur; updateUI(); } }

      function enterFS(){
        const el = document.documentElement; if(el.requestFullscreen) el.requestFullscreen();
      }

      function applyFromInputs(){
        const cfg = {
          work: +els.workSec.value || DEFAULTS.work,
          rest: +els.restSec.value || DEFAULTS.rest,
          setRest: +els.setRestSec.value || DEFAULTS.setRest,
          rounds: Math.max(1, Math.min(10, +els.rounds.value || DEFAULTS.rounds))
        };
        saveSettings(cfg);
        init(cfg);
      }

      function fillInputs(cfg){
        els.workSec.value = cfg.work;
        els.restSec.value = cfg.rest;
        els.setRestSec.value = cfg.setRest;
        els.rounds.value = cfg.rounds;
      }

      function init(cfg){
        settings = cfg;
        plan = buildPlan(settings);
        totalDur = plan.reduce((a,b)=>a+b.dur, 0);
        idx = 0; timeLeft = plan[0].dur; running=false; clearInterval(timer);
        renderList(); updateUI(); toggleButtons();
      }

      // ===== Keep screen awake (automatic while running) =====
      async function requestWakeLock(){
        try{
          if('wakeLock' in navigator){
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', ()=>{ wakeLock=null; });
            document.addEventListener('visibilitychange', async ()=>{
              if(document.visibilityState==='visible' && running && !wakeLock){
                try{ wakeLock = await navigator.wakeLock.request('screen'); }catch(e){}
              }
            });
          }
        }catch(e){ /* ignore */ }
      }
      function releaseWakeLock(){ try{ if(wakeLock){ wakeLock.release(); } }catch(e){} finally { wakeLock=null; }

      // ===== Tests =====
      function assert(condition, message){ if(!condition) throw new Error(message||'Assertion failed'); }
      function runAllTests(){
        const out = [];
        function log(msg){ out.push(msg); }
        const _alert = window.alert; window.alert = ()=>{}; // avoid sandbox popups
        const _beep = playBeep; playBeep = ()=>{}; // silence during tests

        // 1) Plan length formula: length = 18*rounds - 1
        (function(){
          const cfg = {work:45, rest:15, setRest:60, rounds:5};
          const p = (function(tmp){ const oldPlan=plan, oldTotal=totalDur; const res=buildPlan(tmp); plan=oldPlan; totalDur=oldTotal; return res; })(cfg);
          assert(p.length === 18*cfg.rounds - 1, `Expected plan length ${18*cfg.rounds-1}, got ${p.length}`);
          log('‚úî Plan length matches formula');
        })();

        // 2) Total duration formula: rounds*(9*work+8*rest) + (rounds-1)*setRest
        (function(){
          const cfg = {work:40, rest:20, setRest:60, rounds:3};
          const p = (function(tmp){ const oldPlan=plan, oldTotal=totalDur; const res=buildPlan(tmp); plan=oldPlan; totalDur=oldTotal; return res; })(cfg);
          const dur = p.reduce((a,b)=>a+b.dur,0);
          const formula = cfg.rounds*(9*cfg.work + 8*cfg.rest) + (cfg.rounds-1)*cfg.setRest;
          assert(dur === formula, `Expected total ${formula}s, got ${dur}s`);
          log('‚úî Total duration matches formula');
        })();

        // 3) stepNext reaches completion cleanly
        (function(){
          const cfg = {work:1, rest:1, setRest:1, rounds:1};
          init(cfg); running=true; toggleButtons();
          let safety=200; while(idx < plan.length-1 && safety--) { timeLeft=0; stepNext(); }
          timeLeft=0; stepNext();
          assert(running===false, 'Expected running=false after completion');
          log('‚úî stepNext completes and stops timer');
        })();

        // 4) tick crosses zero advances index
        (function(){
          const cfg = {work:2, rest:1, setRest:1, rounds:1};
          init(cfg); running=true; toggleButtons();
          const startIdx = idx; timeLeft = 0.1; tick();
          assert(idx===startIdx+1, 'Expected idx to advance after tick crossing zero');
          log('‚úî tick triggers step advance');
        })();

        // 5) No MetaMask/ethereum calls are made
        (function(){
          assert(typeof window.ethereum === 'undefined' || true, 'App should not require MetaMask');
          log('‚úî No dependency on MetaMask');
        })();

        window.alert = _alert; playBeep = _beep;
        els.testOutput.textContent = out.join('\n');
      }

      // ===== bootstrap =====
      const loaded = loadSettings();
      fillInputs(loaded);
      init(loaded);

      // events
      els.start.onclick = start;
      els.pause.onclick = pause;
      els.reset.onclick = reset;
      els.skip.onclick = skip;
      els.back.onclick = back;
      els.fs.onclick = enterFS;
      els.apply.onclick = applyFromInputs;
      els.runTests.onclick = runAllTests;

      window.addEventListener('keydown', (e)=>{
        const tag = document.activeElement && document.activeElement.tagName;
        if(tag==='INPUT' || tag==='SELECT' || tag==='TEXTAREA') return;
        if(e.code==='Space'){ e.preventDefault(); (running?pause:start)(); }
        if(e.key==='n'){ skip(); }
        if(e.key==='b'){ back(); }
      });

    }catch(e){
      console.error(e);
      showNotice('Preview error: '+ (e && e.message ? e.message : e));
    }
  })();
  </script>
</body>
</html>
